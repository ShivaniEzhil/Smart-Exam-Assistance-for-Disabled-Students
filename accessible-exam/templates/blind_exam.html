<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Exam — Accessible Exam Tool</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to main content</a>

  <main id="main-content" class="exam-layout voice-exam-page" role="main">

    <!-- ===================== TOP BAR ===================== -->
    <div class="exam-topbar voice-exam-topbar">
      <a href="{{ url_for('student_dashboard') }}" class="topbar-link" aria-label="Back to my exams">← My Exams</a>
      <span class="voice-exam-topbar-title" aria-hidden="true">{{ subject }}</span>
      <button class="btn btn-help" onclick="toggleHelp()" aria-label="Help (H)">Help (H)</button>
    </div>

    <!-- ===================== HEADER (status only; subject is in topbar) ===================== -->
    <div class="voice-exam-header">
      <div id="status-bar" class="status-bar voice-exam-status" role="status" aria-live="polite" aria-atomic="true">
        Loading exam…
      </div>
    </div>

    <!-- ===================== HELP PANEL ===================== -->
    <div id="help-panel" class="help-panel voice-exam-help" role="dialog" aria-label="Voice commands and keyboard shortcuts" hidden>
      <h2>Voice Commands</h2>
      <p style="margin:0 0 12px;font-size:0.95rem;opacity:0.85;">Just speak any command after the question is read:</p>
      <ul>
        <li><strong>"Answer"</strong> — Start recording your answer</li>
        <li><strong>"Submit"</strong> — Save answer &amp; go to next</li>
        <li><strong>"Next"</strong> or <strong>"Skip"</strong> — Skip this question</li>
        <li><strong>"Previous"</strong> or <strong>"Back"</strong> — Go to previous question</li>
        <li><strong>"Repeat"</strong> — Hear the question again</li>
        <li><strong>"Add more"</strong> — Continue adding to your answer</li>
        <li><strong>"Listen"</strong> — Hear your recorded answer</li>
        <li><strong>"Clear"</strong> — Erase your answer</li>
        <li><strong>"Review"</strong> — Hear all your answers</li>
        <li><strong>"Help"</strong> — Hear this guide</li>
        <li><strong>"Close Help"</strong> — Close this help panel</li>
        <li><strong>"Faster"</strong> / <strong>"Slower"</strong> — Change speech speed</li>
        <li><strong>"Mute"</strong> / <strong>"Unmute"</strong> — Toggle sound</li>
        <li><strong>"Finish"</strong> — End the exam</li>
      </ul>
      <h3 style="margin-top:16px;">Keyboard Shortcuts (backup)</h3>
      <ul>
        <li><kbd>R</kbd> — Repeat &nbsp; <kbd>A</kbd> — Answer &nbsp; <kbd>D</kbd> — Add more</li>
        <li><kbd>C</kbd> — Clear &nbsp; <kbd>Enter</kbd> — Submit &nbsp; <kbd>N</kbd> — Next</li>
        <li><kbd>P</kbd> — Previous &nbsp; <kbd>V</kbd> — Review &nbsp; <kbd>L</kbd> — Listen</li>
        <li><kbd>M</kbd> — Mute &nbsp; <kbd>H</kbd> — Help &nbsp; <kbd>Esc</kbd> — Cancel</li>
        <li><kbd>+</kbd> / <kbd>−</kbd> — Speed</li>
      </ul>
      <button class="btn btn-read" onclick="toggleHelp()">Close</button>
    </div>

    <!-- ===================== MAIN CONTENT AREA ===================== -->
    <div class="exam-body">
      <!-- LEFT: Question card -->
      <div class="exam-left voice-exam-content">

        <!-- Question number badge -->
        <div id="q-badge" class="q-badge" hidden>
          <span id="q-badge-text">Question 1</span>
        </div>

        <!-- Question text + mute/unmute toggle -->
        <div id="question-box" class="question-card" aria-live="polite" aria-atomic="true">
          <button id="btn-mute" class="btn-speaker" aria-label="Mute audio (shortcut M)" title="Mute / Unmute (M)">
            <svg id="icon-unmuted" class="speaker-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
            <svg id="icon-muted" class="speaker-icon" viewBox="0 0 24 24" fill="currentColor" hidden>
              <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
            </svg>
            <span class="speaker-shortcut">M</span>
          </button>
          <p id="question-text">Loading…</p>
        </div>

        <!-- Diagram warning -->
        <div id="diagram-warning" class="diagram-warning" hidden aria-live="polite">
          ⚠ This question has a diagram/image. Ask your invigilator to describe it.
        </div>

        <!-- Answer display -->
        <div id="answer-box" class="answer-box" hidden aria-live="polite">
          <div class="answer-header">
            <strong>Your Answer:</strong>
            <button id="btn-listen-ans" class="btn-listen-ans" aria-label="Listen to your answer (L)" title="Listen to answer (L)">
              <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
              Listen
            </button>
          </div>
          <p id="answer-text"></p>
        </div>

        <!-- Recording indicator (answer mode) -->
        <div id="recording-bar" class="recording-indicator" hidden aria-live="assertive">
          <span class="recording-dot"></span> Listening… Speak now.
        </div>

        <!-- Voice command indicator -->
        <div id="cmd-bar" class="cmd-indicator" hidden aria-live="polite">
          <span class="cmd-dot"></span> Waiting for voice command…
        </div>

        <!-- Navigation row: Previous / counter / Next -->
        <div id="nav-row" class="q-nav-row" hidden>
          <button id="btn-prev" class="btn btn-nav vex-btn-prev" aria-label="Previous question (P)">← Previous</button>
          <span id="q-counter" class="q-counter">Question 1 of 60</span>
          <button id="btn-next" class="btn btn-nav vex-btn-next" aria-label="Next question (N)">Next →</button>
        </div>

        <!-- Action buttons -->
        <div id="btns-instr" class="action-row voice-exam-actions-instr" hidden>
          <button id="btn-read-instr" class="btn voice-exam-btn-read">Read Instructions</button>
          <button id="btn-start" class="btn voice-exam-btn-start">Start Questions</button>
        </div>

        <div id="btns-main" class="action-row" hidden>
          <button id="btn-repeat" class="btn btn-read vex-btn-repeat" aria-label="Repeat (R)">Repeat</button>
          <button id="btn-answer" class="btn btn-answer vex-btn-answer" aria-label="Answer (A)">Answer</button>
          <button id="btn-add-more" class="btn btn-add-more vex-btn-add-more" aria-label="Add More (D)" hidden>+ Add More</button>
          <button id="btn-clear" class="btn btn-clear vex-btn-clear" aria-label="Clear (C)" hidden>Clear</button>
        </div>

        <div id="btns-submit" class="action-row" hidden>
          <button id="btn-submit-next" class="btn btn-submit vex-btn-submit" aria-label="Submit & Next (Enter)">Submit &amp; Next</button>
        </div>

        <div id="btns-done" class="action-row" hidden>
          <button id="btn-review" class="btn btn-read vex-btn-repeat" aria-label="Review (V)">Review Answers</button>
          <button id="btn-finish" class="btn btn-submit vex-btn-submit" aria-label="Finish (Enter)">Finish Exam</button>
        </div>
      </div>

      <!-- RIGHT: Question grid -->
      <div class="exam-right" id="grid-panel" hidden>
        <h3 class="grid-title">Questions</h3>
        <div id="q-grid" class="q-grid" role="navigation" aria-label="Jump to question">
          <!-- filled by JS -->
        </div>
      </div>

    </div>

    <!-- Speed indicator -->
    <div id="speed-indicator" class="speed-indicator" aria-live="polite" hidden>
      Speed: <span id="speed-value">1.0×</span>
    </div>

  </main>

  <!-- DATA from Flask (application/json is not executed, just read by JS) -->
  <script id="exam-json" type="application/json">
  {
    "instructions": {{ instructions | tojson }},
    "questions":    {{ questions | tojson }},
    "answers":      {{ answers | tojson }},
    "total":        {{ total_questions }}
  }
  </script>

  <script>
    /* ==========================  DATA  ========================== */
    var _raw = JSON.parse(document.getElementById('exam-json').textContent);
    var INSTRUCTIONS  = _raw.instructions  || [];
    var QUESTIONS     = _raw.questions     || [];
    var SAVED_ANSWERS = _raw.answers       || {};
    var TOTAL         = _raw.total         || 0;

    /* ==========================  STATE  ========================= */
    var phase   = 'instructions';
    var qIdx    = 0;
    var answers = {};
    var rate    = 1.0;
    var speaking = false, listening = false;
    Object.keys(SAVED_ANSWERS).forEach(function (k) { answers[k] = SAVED_ANSWERS[k]; });

    /* ==========================  DOM  =========================== */
    var $status   = document.getElementById('status-bar');
    var $qText    = document.getElementById('question-text');
    var $aBox     = document.getElementById('answer-box');
    var $aText    = document.getElementById('answer-text');
    var $recBar   = document.getElementById('recording-bar');
    var $cmdBar   = document.getElementById('cmd-bar');
    var $diagWarn = document.getElementById('diagram-warning');
    var $help     = document.getElementById('help-panel');
    var $speedInd = document.getElementById('speed-indicator');
    var $speedVal = document.getElementById('speed-value');
    var $badge    = document.getElementById('q-badge');
    var $badgeTxt = document.getElementById('q-badge-text');
    var $navRow   = document.getElementById('nav-row');
    var $counter  = document.getElementById('q-counter');
    var $gridPnl  = document.getElementById('grid-panel');
    var $grid     = document.getElementById('q-grid');

    var $bInstr   = document.getElementById('btns-instr');
    var $bMain    = document.getElementById('btns-main');
    var $bSub     = document.getElementById('btns-submit');
    var $bDone    = document.getElementById('btns-done');

    var btnReadI  = document.getElementById('btn-read-instr');
    var btnStart  = document.getElementById('btn-start');
    var btnRepeat = document.getElementById('btn-repeat');
    var btnAnswer = document.getElementById('btn-answer');
    var btnAddMore = document.getElementById('btn-add-more');
    var btnClear  = document.getElementById('btn-clear');
    var btnPrev   = document.getElementById('btn-prev');
    var btnNext   = document.getElementById('btn-next');
    var btnSubN   = document.getElementById('btn-submit-next');
    var btnReview = document.getElementById('btn-review');
    var btnFinish = document.getElementById('btn-finish');

    /* ==========================  GRID  ========================== */
    function buildGrid() {
      $grid.innerHTML = '';
      for (var i = 0; i < TOTAL; i++) {
        var b = document.createElement('button');
        b.className = 'grid-btn';
        b.textContent = 'Q' + (i + 1);
        b.dataset.idx = i;
        b.setAttribute('aria-label', 'Jump to question ' + (i + 1));
        b.addEventListener('click', (function (idx) {
          return function () { qIdx = idx; showQ(); };
        })(i));
        $grid.appendChild(b);
      }
    }

    function updateGrid() {
      var btns = $grid.querySelectorAll('.grid-btn');
      for (var i = 0; i < btns.length; i++) {
        btns[i].classList.remove('grid-current', 'grid-answered');
        if (i === qIdx) btns[i].classList.add('grid-current');
        else if (answers[String(i)]) btns[i].classList.add('grid-answered');
      }
    }

    /* ==========================  TTS  =========================== */
    var synth = window.speechSynthesis;
    function say(text, cb) {
      synth.cancel(); speaking = true;
      var u = new SpeechSynthesisUtterance(text);
      u.rate = rate; u.pitch = 1; u.volume = 1;
      u.onend = function () { speaking = false; if (cb) cb(); };
      u.onerror = function () { speaking = false; };
      synth.speak(u);
    }
    function hush() { synth.cancel(); speaking = false; }

    /* Female voice for reading answers back */
    var answerVoice = null;
    function pickAnswerVoice() {
      var voices = synth.getVoices();
      if (!voices.length) return;
      var preferred = [
        'samantha', 'karen', 'moira', 'tessa', 'fiona', 'veena',
        'victoria', 'zira', 'susan', 'hazel', 'catherine',
        'google uk english female', 'google us english female',
        'microsoft zira', 'microsoft hazel'
      ];
      for (var p = 0; p < preferred.length; p++) {
        for (var i = 0; i < voices.length; i++) {
          if (voices[i].name.toLowerCase().indexOf(preferred[p]) !== -1) {
            answerVoice = voices[i]; return;
          }
        }
      }
      for (var i = 0; i < voices.length; i++) {
        if (voices[i].name.toLowerCase().indexOf('female') !== -1) {
          answerVoice = voices[i]; return;
        }
      }
    }
    pickAnswerVoice();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = pickAnswerVoice;
    }

    function sayAnswer(text, cb) {
      if (muted) { if (cb) cb(); return; }
      synth.cancel(); speaking = true;
      var u = new SpeechSynthesisUtterance(text);
      if (answerVoice) u.voice = answerVoice;
      u.rate = rate;
      u.pitch = 1.15;
      u.volume = 0.9;
      u.onend = function () { speaking = false; if (cb) cb(); };
      u.onerror = function () { speaking = false; };
      synth.speak(u);
    }

    function listenAnswer() {
      var ans = answers[String(qIdx)];
      if (!ans) { say('No answer recorded yet.'); return; }
      sayAnswer('Your answer is: ' + ans);
    }

    /* ==========================  STT  =========================== */
    var SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    var rec = null;
    var appendMode = false;

    function listen() {
      appendMode = false;
      startListening('Listening. Speak your answer now.');
    }

    function listenAppend() {
      if (!answers[String(qIdx)]) { listen(); return; }
      appendMode = true;
      startListening('Add more to your answer. Speak now.');
    }

    var SILENCE_TIMEOUT = 15000;  /* 15 seconds of silence = done */
    var silenceTimer = null;
    var collectedText = '';

    function startListening(prompt) {
      if (!SpeechRec) { say('Speech recognition not supported. Use Chrome.'); return; }
      if (phase !== 'questions' || listening) return;
      listening = true; $recBar.hidden = false;
      collectedText = '';
      stat('Listening…');
      say(prompt, function () {
        rec = new SpeechRec();
        rec.lang = 'en-US';
        rec.continuous = true;
        rec.interimResults = true;
        rec.maxAlternatives = 1;

        rec.onresult = function (e) {
          /* Build full transcript from all final + interim results */
          var final = '', interim = '';
          for (var i = 0; i < e.results.length; i++) {
            if (e.results[i].isFinal) {
              final += e.results[i][0].transcript + ' ';
            } else {
              interim += e.results[i][0].transcript;
            }
          }
          collectedText = final.trim();
          var display = (collectedText + ' ' + interim).trim();
          $recBar.innerHTML = '<span class="recording-dot"></span> Listening… <span class="rec-preview">' + display + '</span>';
          stat('Listening… (speak, pause to finish)');

          /* Reset silence timer — student is still speaking */
          clearTimeout(silenceTimer);
          silenceTimer = setTimeout(function () {
            finishListening();
          }, SILENCE_TIMEOUT);
        };

        rec.onerror = function (e) {
          clearTimeout(silenceTimer);
          listening = false; $recBar.hidden = true;
          $recBar.innerHTML = '<span class="recording-dot"></span> Listening… Speak now.';
          if (e.error === 'no-speech') say('No speech detected. Say answer to try again.');
          else if (e.error === 'not-allowed') say('Microphone blocked. Please allow microphone access.');
          else if (e.error !== 'aborted') say('Could not recognise. Say answer to try again.');
          stat('Say answer to try again.');
        };

        rec.onend = function () {
          /* If we still have text and listening was active, finalize */
          if (listening && collectedText) {
            clearTimeout(silenceTimer);
            finishListening();
          } else if (listening) {
            listening = false; $recBar.hidden = true;
            $recBar.innerHTML = '<span class="recording-dot"></span> Listening… Speak now.';
          }
        };

        /* Start the silence timer for initial silence too */
        silenceTimer = setTimeout(function () {
          if (listening && !collectedText) {
            stopRec();
            say('No speech detected. Say answer to try again.');
            stat('Say answer to try again.');
          }
        }, 8000); /* 8s initial wait */

        rec.start();
      });
    }

    function finishListening() {
      clearTimeout(silenceTimer);
      if (rec) { try { rec.stop(); } catch(e) {} }
      listening = false; $recBar.hidden = true;
      $recBar.innerHTML = '<span class="recording-dot"></span> Listening… Speak now.';

      if (!collectedText) return;

      if (appendMode && answers[String(qIdx)]) {
        onVoiceAppend(collectedText);
      } else {
        onVoice(collectedText);
      }
      collectedText = '';
    }

    function stopRec() {
      clearTimeout(silenceTimer);
      if (rec) { try { rec.abort(); } catch(e) {} }
      listening = false; $recBar.hidden = true;
      $recBar.innerHTML = '<span class="recording-dot"></span> Listening… Speak now.';
      collectedText = '';
    }

    /* ==========================  ANSWER  ======================== */
    function onVoice(text) {
      answers[String(qIdx)] = text;
      $aText.textContent = text; $aBox.hidden = false;
      btnClear.hidden = false; btnAddMore.hidden = false;
      updateGrid();
      stat('Answer recorded.');
      sayAnswer('Your answer: ' + text, function () {
        say('Say submit, add more, answer again, or clear.');
      });
    }

    function onVoiceAppend(text) {
      var existing = answers[String(qIdx)];
      var combined = existing + ' ' + text;
      answers[String(qIdx)] = combined;
      $aText.textContent = combined; $aBox.hidden = false;
      btnClear.hidden = false; btnAddMore.hidden = false;
      updateGrid();
      stat('Added to answer.');
      sayAnswer('Added. Full answer: ' + combined, function () {
        say('Say add more, submit, or clear.');
      });
    }
    function clearAns() {
      hush(); delete answers[String(qIdx)];
      $aText.textContent = ''; $aBox.hidden = true;
      btnClear.hidden = true; btnAddMore.hidden = true;
      updateGrid(); stat('Cleared.');
      say('Answer cleared. Say answer to record again.');
    }
    function submitNext() {
      hush();
      var ans = answers[String(qIdx)];
      if (!ans) { say('No answer yet. Say answer to record, or say next to skip.'); return; }
      saveAnswer(qIdx, ans);
      if (qIdx < TOTAL - 1) { say('Submitted.', function () { qIdx++; showQ(); }); }
      else { say('Submitted. Last question done.', function () { showDone(); }); }
    }
    function skip() {
      hush();
      if (phase === 'instructions') { qIdx = 0; showQ(); return; }
      if (qIdx < TOTAL - 1) { say('Skipped.', function () { qIdx++; showQ(); }); }
      else say('Last question. Submit or review.');
    }
    function prev() { hush(); if (phase === 'questions' && qIdx > 0) { qIdx--; showQ(); } }
    function saveAnswer(idx, text) {
      fetch('/api/save-answer', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question_index: idx, answer: text })
      }).catch(function (e) { console.error('Save failed', e); });
    }

    /* ==========================  PHASES  ======================== */
    function showInstr() {
      phase = 'instructions'; qIdx = 0;
      $qText.textContent = INSTRUCTIONS.length ? INSTRUCTIONS.join('\n') : 'No instructions.';
      hideAll(); $bInstr.hidden = false;
      $badge.hidden = true; $navRow.hidden = true; $gridPnl.hidden = true;
      $aBox.hidden = true; $diagWarn.hidden = true;
      stat(INSTRUCTIONS.length + ' instructions, ' + TOTAL + ' questions.');
      say('Welcome to your exam. ' + TOTAL + ' questions. Say repeat to hear instructions, or say start to begin.');
    }

    function showQ() {
      phase = 'questions';
      if (qIdx >= TOTAL) { showDone(); return; }

      var q   = QUESTIONS[qIdx];
      var num = qIdx + 1;
      var hasDiag = /\[NOTE:.*diagram|figure|image/i.test(q);

      // Badge
      $badge.hidden = false;
      $badgeTxt.textContent = 'Question ' + num;

      // Question text
      $qText.textContent = q;
      $diagWarn.hidden = !hasDiag;

      // Answer
      if (answers[String(qIdx)]) {
        $aText.textContent = answers[String(qIdx)];
        $aBox.hidden = false; btnClear.hidden = false; btnAddMore.hidden = false;
      } else {
        $aBox.hidden = true; btnClear.hidden = true; btnAddMore.hidden = true;
      }
      $recBar.hidden = true;

      // Navigation
      $navRow.hidden = false;
      btnPrev.style.visibility = (qIdx > 0) ? 'visible' : 'hidden';
      btnNext.style.visibility = (qIdx < TOTAL - 1) ? 'visible' : 'hidden';
      $counter.textContent = 'Question ' + num + ' of ' + TOTAL;

      // Buttons
      hideAll();
      $bMain.hidden = false; $bSub.hidden = false;

      // Grid
      $gridPnl.hidden = false;
      updateGrid();

      stat('Question ' + num + ' of ' + TOTAL);
      var speech = 'Question ' + num + ' of ' + TOTAL + '. ' + q;
      if (hasDiag) speech += ' Warning: this question has a diagram. Ask your invigilator.';
      speech += ' Say answer to record, or say help for commands.';
      say(speech);
    }

    function showDone() {
      phase = 'completed';
      var n = Object.keys(answers).length;
      $badge.hidden = true;
      $qText.textContent = 'Exam complete!\n\nYou answered ' + n + ' of ' + TOTAL + ' questions.';
      hideAll(); $bDone.hidden = false;
      $navRow.hidden = true; $aBox.hidden = true; $diagWarn.hidden = true;
      updateGrid();
      say('Exam complete. ' + n + ' of ' + TOTAL + ' answered. Say review to hear your answers, or say finish to end.');
    }

    function hideAll() {
      $bInstr.hidden = true; $bMain.hidden = true;
      $bSub.hidden = true; $bDone.hidden = true;
    }

    /* ==========================  REPEAT / REVIEW  =============== */
    function repeat() {
      hush();
      if (phase === 'instructions') say('Instructions. ' + (INSTRUCTIONS.length ? INSTRUCTIONS.join('. ') : 'None.'));
      else if (phase === 'questions') say('Question ' + (qIdx + 1) + ' of ' + TOTAL + '. ' + QUESTIONS[qIdx]);
    }
    function review() {
      hush(); var parts = [];
      for (var i = 0; i < TOTAL; i++) parts.push('Question ' + (i + 1) + ': ' + (answers[String(i)] || 'Not answered'));
      say('Your answers. ' + parts.join('. '));
    }
    function finish() { window.location.href = '/completed'; }

    /* ==========================  SPEED  ========================= */
    function faster() { rate = Math.min(rate + 0.25, 3); showSpd(); }
    function slower() { rate = Math.max(rate - 0.25, 0.5); showSpd(); }
    function showSpd() {
      $speedVal.textContent = rate.toFixed(1) + '×'; $speedInd.hidden = false;
      say('Speed ' + rate.toFixed(1));
      setTimeout(function () { $speedInd.hidden = true; }, 3000);
    }

    /* ==========================  HELP  ========================== */
    function toggleHelp() {
      var open = $help.hidden; $help.hidden = !open;
      if (open) say('Help. You can control this exam by speaking commands. Say: answer to record. Submit to save and go next. Next to skip. Previous to go back. Repeat to hear the question again. Add more to extend your answer. Listen to hear your answer. Clear to erase your answer. Review to hear all answers. Help for this guide. Close to close help. Mute or unmute to toggle sound. Faster or slower to change speed. Finish to end the exam. You can also use keyboard shortcuts as a backup.');
      else say('Help closed.');
    }

    /* ==========================  VOICE COMMANDS  ================= */
    var cmdRec = null;
    var cmdActive = false;

    /* Map spoken words to actions */
    function handleVoiceCommand(text) {
      var t = text.toLowerCase().trim();

      /* Instructions phase */
      if (phase === 'instructions') {
        if (/\b(start|begin|go|next|enter)\b/.test(t)) { qIdx = 0; showQ(); return; }
        if (/\b(read|repeat|instructions?)\b/.test(t)) { repeat(); return; }
      }

      /* Completed phase */
      if (phase === 'completed') {
        if (/\b(review|answers?)\b/.test(t)) { review(); return; }
        if (/\b(finish|done|exit|end|submit)\b/.test(t)) { finish(); return; }
      }

      /* Close help — works in any phase */
      if (/\b(close\s*help|close|hide\s*help)\b/.test(t) && !$help.hidden) {
        toggleHelp(); return;
      }

      /* Questions phase */
      if (phase === 'questions') {
        if (/\b(answer|record|speak)\b/.test(t)) { listen(); return; }
        if (/\b(add\s*more|continue|append)\b/.test(t)) { listenAppend(); return; }
        if (/\b(repeat|read\s*again|again)\b/.test(t)) { repeat(); return; }
        if (/\b(submit|done|save)\b/.test(t)) { submitNext(); return; }
        if (/\b(next|skip|forward)\b/.test(t)) { skip(); return; }
        if (/\b(previous|back|go\s*back)\b/.test(t)) { prev(); return; }
        if (/\b(clear|erase|delete|remove)\b/.test(t)) { clearAns(); return; }
        if (/\b(listen|hear|play)\b/.test(t)) { listenAnswer(); return; }
        if (/\b(review|all\s*answers?)\b/.test(t)) { review(); return; }
        if (/\b(help|commands?|options?|what\s*can)\b/.test(t)) { toggleHelp(); return; }
        if (/\b(mute|unmute|quiet|sound)\b/.test(t)) { toggleMute(); return; }
        if (/\b(faster|speed\s*up)\b/.test(t)) { faster(); return; }
        if (/\b(slower|slow\s*down)\b/.test(t)) { slower(); return; }
        if (/\b(finish|end\s*exam)\b/.test(t)) { showDone(); return; }
      }

      /* Command not recognized */
      say('Sorry, I did not understand. Say: answer, repeat, submit, next, previous, add more, clear, listen, or help.');
    }

    function startCommandListening() {
      if (!SpeechRec || muted || listening || cmdActive) return;
      /* Small delay so TTS finishes cleanly before mic opens */
      setTimeout(function () {
        if (listening || cmdActive || speaking) {
          /* TTS still going — wait and retry */
          var retryCheck = setInterval(function () {
            if (!speaking && !listening && !cmdActive) {
              clearInterval(retryCheck);
              openCommandMic();
            }
          }, 300);
        } else {
          openCommandMic();
        }
      }, 500);
    }

    function openCommandMic() {
      if (listening || cmdActive || muted) return;
      cmdActive = true;
      $cmdBar.hidden = false;
      cmdRec = new SpeechRec();
      cmdRec.lang = 'en-US';
      cmdRec.continuous = false;
      cmdRec.interimResults = false;
      cmdRec.maxAlternatives = 1;

      cmdRec.onresult = function (e) {
        cmdActive = false;
        $cmdBar.hidden = true;
        var command = e.results[0][0].transcript;
        stat('Voice command: "' + command + '"');
        handleVoiceCommand(command);
      };
      cmdRec.onerror = function (e) {
        cmdActive = false;
        $cmdBar.hidden = true;
        if (e.error === 'no-speech') {
          /* Silently restart — student just hasn't spoken yet */
          startCommandListening();
        }
        /* Other errors: do nothing, keyboard still works */
      };
      cmdRec.onend = function () {
        if (cmdActive) {
          cmdActive = false;
          $cmdBar.hidden = true;
          /* Auto-restart if no command was captured */
          if (!listening && !speaking) startCommandListening();
        }
      };

      try { cmdRec.start(); } catch(e) { cmdActive = false; $cmdBar.hidden = true; }
    }

    function stopCommandListening() {
      cmdActive = false;
      $cmdBar.hidden = true;
      if (cmdRec) { try { cmdRec.abort(); } catch(e) {} }
    }

    /* Stop command mic when answer recording starts */
    var _origStartListening = startListening;
    var _patchedStartListening = function (prompt) {
      stopCommandListening();
      _origStartListening(prompt);
    };
    // Re-wire listen/listenAppend to use patched version
    listen = function () {
      appendMode = false;
      _patchedStartListening('Speak your answer now.');
    };
    listenAppend = function () {
      if (!answers[String(qIdx)]) { listen(); return; }
      appendMode = true;
      _patchedStartListening('Add more to your answer. Speak now.');
    };

    /* ==========================  UTILITY  ======================= */
    function stat(t) { $status.textContent = t; }

    /* ==========================  KEYS  ========================== */
    document.addEventListener('keydown', function (e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      stopCommandListening(); /* Stop command mic when keyboard is used */
      var k = e.key.toLowerCase();
      if (k === 'h')     { e.preventDefault(); toggleHelp(); return; }
      if (k === 'escape') {
        e.preventDefault();
        if (!$help.hidden) toggleHelp();
        else if (listening) { stopRec(); say('Cancelled.'); }
        else hush();
        return;
      }
      if (k === '+' || k === '=') { e.preventDefault(); faster(); return; }
      if (k === '-')              { e.preventDefault(); slower(); return; }
      if (k === 's')              { e.preventDefault(); showSpd(); return; }
      if (k === 'v')              { e.preventDefault(); review(); return; }
      if (k === 'm')              { e.preventDefault(); toggleMute(); return; }
      if (k === 'l')              { e.preventDefault(); listenAnswer(); return; }
      if (k === 'r')              { e.preventDefault(); repeat(); return; }
      if (k === 'a')              { e.preventDefault(); listen(); return; }
      if (k === 'd')              { e.preventDefault(); if (phase === 'questions') listenAppend(); return; }
      if (k === 'c')              { e.preventDefault(); if (phase === 'questions') clearAns(); return; }
      if (k === 'enter') {
        e.preventDefault();
        if (phase === 'instructions') { qIdx = 0; showQ(); }
        else if (phase === 'questions') submitNext();
        else if (phase === 'completed') finish();
        return;
      }
      if (k === 'n' || k === 'arrowright') { e.preventDefault(); skip(); return; }
      if (k === 'p' || k === 'arrowleft')  { e.preventDefault(); prev(); return; }
    });

    /* ==========================  MUTE TOGGLE  =================== */
    var muted = false;
    var $btnMute   = document.getElementById('btn-mute');
    var $iconOn    = document.getElementById('icon-unmuted');
    var $iconOff   = document.getElementById('icon-muted');

    function toggleMute() {
      muted = !muted;
      if (muted) {
        hush(); stopRec(); stopCommandListening();
        $iconOn.hidden = true; $iconOff.hidden = false;
        $btnMute.setAttribute('aria-label', 'Unmute audio');
        $btnMute.classList.add('is-muted');
        stat('Audio muted. Voice commands paused.');
      } else {
        $iconOn.hidden = false; $iconOff.hidden = true;
        $btnMute.setAttribute('aria-label', 'Mute audio');
        $btnMute.classList.remove('is-muted');
        stat('Audio unmuted.');
        // Re-read current question after unmuting
        repeat();
      }
    }

    // Override say() to respect mute
    var _realSay = say;
    say = function (text, cb) {
      if (muted) { if (cb) cb(); return; }
      _realSay(text, cb);
    };

    $btnMute.addEventListener('click', toggleMute);

    /* ========  VOICE COMMAND: Hook say() and sayAnswer()  ======= */
    /* Wrap say() so after every TTS, we auto-start command listening */
    var _sayBeforeCmd = say;
    say = function (text, cb) {
      stopCommandListening();
      /* Use a wrapper callback that starts command listening after speech */
      _sayBeforeCmd(text, function () {
        if (cb) cb();
        if (!listening && !speaking && !muted) {
          startCommandListening();
        }
      });
    };

    /* Wrap sayAnswer() similarly */
    var _sayAnswerBeforeCmd = sayAnswer;
    sayAnswer = function (text, cb) {
      stopCommandListening();
      _sayAnswerBeforeCmd(text, function () {
        if (cb) cb();
        if (!listening && !speaking && !muted) {
          startCommandListening();
        }
      });
    };

    /* ==========================  CLICKS  ======================== */
    btnReadI.addEventListener('click',  function () { repeat(); });
    btnStart.addEventListener('click',  function () { qIdx = 0; showQ(); });
    btnRepeat.addEventListener('click', function () { repeat(); });
    btnAnswer.addEventListener('click', function () { listen(); });
    btnAddMore.addEventListener('click', function () { listenAppend(); });
    btnClear.addEventListener('click',  function () { clearAns(); });
    document.getElementById('btn-listen-ans').addEventListener('click', function () { listenAnswer(); });
    btnPrev.addEventListener('click',   function () { prev(); });
    btnNext.addEventListener('click',   function () { skip(); });
    btnSubN.addEventListener('click',   function () { submitNext(); });
    btnReview.addEventListener('click', function () { review(); });
    btnFinish.addEventListener('click', function () { finish(); });

    /* ==========================  INIT  ========================== */
    buildGrid();

    // Run immediately — don't wait for onload (it may already have fired)
    (function init() {
      if (TOTAL > 0 && INSTRUCTIONS.length === 0) {
        // No separate instructions — start with question 1 right away
        showQ();
      } else if (INSTRUCTIONS.length > 0) {
        showInstr();
      } else {
        say('No content found. Go back and upload a paper.');
      }
    })();
  </script>

</body>
</html>
